<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comments</title>
    <style>
    body {
        font-family: sans-serif;
        background-color: #f4f4f4;
        color: #333;
        margin: 20px;
    }

    h1 {
        text-align: center;
    }

    #comments-container {
        max-width: 800px;
        margin: 0 auto;
        background-color: #fff;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .comment {
        border-bottom: 1px solid #eee;
        padding: 15px 0;
    }

    .comment:last-child {
        border-bottom: none;
    }

    .comment-author {
        font-weight: bold;
        color: #0056b3;
        margin-bottom: 5px;
    }

    .comment-text {
        line-height: 1.6;
    }

    .comment-text img {
        max-width: 100%;
        height: auto;
        border-radius: 4px;
    }

    .comment-date {
        font-size: 0.8em;
        color: #666;
        margin-top: 10px;
    }

    .answers-container {
        margin-left: 20px;
        border-left: 2px solid #eee;
        padding-left: 10px;
    }

    .comment-votes {
        font-size: 0.8em;
        color: #666;
        margin-top: 10px;
    }

    .comment-level {
        font-size: 0.8em;
        color: #666;
        margin-bottom: 5px;
    }

    .comment-header {
        display: flex;
        align-items: center;
        margin-bottom: 10px;
    }

    .comment-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        margin-right: 10px;
    }
    </style>
</head>
<body>
    <h1>Comments</h1>
    <div id="comments-container"></div>
    <!-- Modal for comment metadata -->
    <div id="comment-modal" aria-hidden="true" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); align-items:center; justify-content:center; z-index:9999;">
        <div id="comment-modal-dialog" style="background:#fff; max-width:720px; width:90%; border-radius:8px; padding:16px; box-shadow:0 6px 24px rgba(0,0,0,0.2);">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                <h2 id="comment-modal-title" style="margin:0; font-size:1.1rem">Comment metadata</h2>
                <button id="comment-modal-close" aria-label="Close" style="background:#eee;border:0;padding:6px 10px;border-radius:6px;cursor:pointer">Close</button>
            </div>
            <div id="comment-modal-body" style="max-height:60vh; overflow:auto; font-size:0.95rem; color:#222;"></div>
        </div>
    </div>
    <!-- Modal for geo details -->
    <div id="geo-modal" aria-hidden="true" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); align-items:center; justify-content:center; z-index:10000;">
        <div id="geo-modal-dialog" style="background:#fff; max-width:640px; width:92%; border-radius:8px; padding:14px; box-shadow:0 6px 24px rgba(0,0,0,0.22);">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                <h3 id="geo-modal-title" style="margin:0; font-size:1rem">IP geolocation</h3>
                <button id="geo-modal-close" aria-label="Close geo" style="background:#eee;border:0;padding:6px 10px;border-radius:6px;cursor:pointer">Close</button>
            </div>
            <div id="geo-modal-body" style="max-height:60vh; overflow:auto; font-size:0.95rem; color:#222;"></div>
        </div>
    </div>
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const commentsContainer = document.getElementById('comments-container');
    const commentModal = document.getElementById('comment-modal');
    const commentModalBody = document.getElementById('comment-modal-body');
    const commentModalClose = document.getElementById('comment-modal-close');
    // simple in-memory cache for IP geolocation results to avoid repeated external calls
    const geoCache = new Map(); // ip -> { ok: true, data } | { ok: false, error }
    const geoModal = document.getElementById('geo-modal');
    const geoModalBody = document.getElementById('geo-modal-body');
    const geoModalClose = document.getElementById('geo-modal-close');
        const params = new URLSearchParams(window.location.search);
        const storyId = params.get('storyId');

        if (!storyId) {
            commentsContainer.innerHTML = '<p>Please provide a storyId in the URL. (e.g., ?storyId=914354)</p>';
            return;
        }

        const storyUrl = `https://reactions-api.s3.eu-west-3.amazonaws.com/story/${storyId}.json`;
        const mainTitle = document.querySelector('h1');

        async function fetchStoryData() {
            const response = await fetch(storyUrl);
            if (!response.ok) {
                throw new Error('Could not fetch story metadata.');
            }
            const data = await response.json();
            const commentsUrl = data.cdnFiles.find(url => url.includes('/asc/hierarchie/'));
            if (!commentsUrl) {
                throw new Error('Could not find comments URL.');
            }

            mainTitle.innerHTML = `<a href="${data.url}" target="_blank">${data.title}</a>`;

            // remove the 1.json from the url
            return commentsUrl.substring(0, commentsUrl.lastIndexOf('/') + 1);
        }

        async function fetchAllComments(baseUrl) {
            const firstPageUrl = `${baseUrl}1.json`;
            const firstPageResponse = await fetch(firstPageUrl);
            if (!firstPageResponse.ok) {
                throw new Error('Could not fetch the first page of comments.');
            }
            const firstPageData = await firstPageResponse.json();
            let allComments = firstPageData.comments;

            const totalPages = firstPageData.pages;
            if (totalPages > 1) {
                const pagePromises = [];
                for (let page = 2; page <= totalPages; page++) {
                    const pageUrl = `${baseUrl}${page}.json`;
                    pagePromises.push(fetch(pageUrl).then(res => res.json()));
                }
                const subsequentPagesData = await Promise.all(pagePromises);
                subsequentPagesData.forEach(pageData => {
                    if (pageData.comments) {
                        allComments = allComments.concat(pageData.comments);
                    }
                });
            }

            displayComments(allComments);
        }

        // CommentModel maps the JSON response to a clean object and exposes a metadata renderer
        class CommentModel {
            constructor(json) {
                // copy most useful fields and keep original JSON
                this.raw = json;
                this.id = json.id;
                this.storyId = json.storyId;
                this.parentId = json.parentId;
                this.memberId = json.memberId;
                this.member = json.member;
                this.memberInitiales = json.memberInitiales;
                this.memberRating = json.memberRating;
                this.memberIsVip = json.memberIsVip;
                this.createdAt = json.createdAt;
                this.body = json.body;
                this.rating = json.rating;
                this.upvotes = json.upvotes;
                this.downvotes = json.downvotes;
                this.ip = json.ip;
                this.avatar = json.avatar;
                this.mention = json.mention;
                this.level = json.level;
                this.memberMeta = json.memberMeta || null;
                this.answers = json.answers || [];
                this.depth = json.depth || 0;
                this.rich = json.rich || false;
                this.since = json['since'] || json['since-full'] || '';
                this.parsed = json.parsed || false;
                this.editable = json.editable || false;
            }

            // small renderer to produce an object->HTML list of metadata
            renderMetadata() {
                const rows = [];
                const push = (k, v) => rows.push(`<div style="margin-bottom:6px"><strong>${escapeHtml(k)}:</strong> <span style="color:#333">${escapeHtml(String(v))}</span></div>`);

                push('id', this.id);
                push('storyId', this.storyId);
                push('parentId', this.parentId === false ? 'false' : (this.parentId ?? ''));
                push('memberId', this.memberId);
                push('member', this.member);
                push('memberInitiales', this.memberInitiales);
                push('memberRating', this.memberRating);
                push('memberIsVip', this.memberIsVip);
                push('createdAt', this.createdAt);
                push('since', this.since);
                push('rating', this.rating);
                push('upvotes', this.upvotes);
                push('downvotes', this.downvotes);
                // show IP and a button to open the geo modal (no inline geo text in this modal)
                rows.push(`<div style="margin-bottom:6px"><strong>ip:</strong> <span style="color:#333">${escapeHtml(this.ip || '')}</span> <button id="geo-btn-${escapeHtml(String(this.id))}" disabled style="margin-left:8px;padding:4px 6px;border-radius:6px;border:0;cursor:pointer">Show geo details</button></div>`);
                push('level', this.level || '');
                push('depth', this.depth);
                push('parsed', this.parsed);
                push('editable', this.editable);
                push('answersCount', this.answers.length);

                if (this.memberMeta) {
                    const metaItems = Object.keys(this.memberMeta).map(k => `${escapeHtml(k)}: ${escapeHtml(String(this.memberMeta[k]))}`).join('<br>');
                    rows.push(`<div style="margin-top:8px"><strong>memberMeta:</strong><div style="margin-left:6px;">${metaItems}</div></div>`);
                }

                // provide a preview of the original text
                rows.push(`<hr style="border:none;border-top:1px solid #eee;margin:10px 0">`);
                rows.push(`<div><strong>original:</strong><div style="margin-top:6px; color:#111;">${escapeHtml(this.raw.original ?? this.body ?? '')}</div></div>`);

                return rows.join('');
            }
        }

        function escapeHtml(str) {
            return String(str)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        async function fetchGeoForIp(ip) {
            if (!ip) return { ok: false, error: 'no-ip' };
            if (geoCache.has(ip)) return geoCache.get(ip);
            try {
                // ipwho.is is free for basic lookups and CORS-friendly
                const resp = await fetch(`https://ipwho.is/${encodeURIComponent(ip)}`);
                if (!resp.ok) throw new Error('network-error');
                const data = await resp.json();
                const result = { ok: !!data.success, data };
                geoCache.set(ip, result);
                return result;
            } catch (err) {
                const result = { ok: false, error: String(err) };
                geoCache.set(ip, result);
                return result;
            }
        }

        async function showCommentMetadata(commentJson) {
            const model = new CommentModel(commentJson);
            commentModalBody.innerHTML = model.renderMetadata();
            commentModal.style.display = 'flex';
            commentModal.setAttribute('aria-hidden', 'false');

            // attempt to load geo info for the IP and enable the geo details button
            const ip = model.ip;
            const detailsButton = commentModalBody.querySelector(`#${CSS.escape('geo-btn-' + String(model.id))}`);
            if (!ip || !detailsButton) return;

            // If the comment JSON already contains geo info, enable button immediately
            if (model.raw.geo) {
                detailsButton.disabled = false;
                detailsButton.addEventListener('click', (ev) => {
                    ev.stopPropagation();
                    openGeoModal(model.id, ip, model.raw.geo);
                });
                return;
            }

            // otherwise fetch geo and enable button when available
            detailsButton.disabled = true;
            const geo = await fetchGeoForIp(ip);
            if (!geo.ok) {
                detailsButton.disabled = true;
                return;
            }
            const d = geo.data;
            detailsButton.disabled = false;
            detailsButton.addEventListener('click', (ev) => {
                ev.stopPropagation();
                openGeoModal(model.id, ip, d);
            });
        }

        function openGeoModal(commentId, ip, geoData) {
            geoModalBody.innerHTML = renderGeoDetails(commentId, ip, geoData);
            geoModal.style.display = 'flex';
            geoModal.setAttribute('aria-hidden', 'false');
        }

        function renderGeoDetails(commentId, ip, d) {
            const parts = [];
            if (d.city) parts.push(escapeHtml(d.city));
            if (d.region) parts.push(escapeHtml(d.region));
            if (d.country) parts.push(escapeHtml(d.country));
            const coords = (d.latitude && d.longitude) ? `${d.latitude},${d.longitude}` : '';
            const isp = d.connection && (d.connection.isp || d.connection.org) ? escapeHtml(d.connection.isp || d.connection.org) : '';

            return `
                <div style="margin-bottom:8px"><strong>IP</strong>: ${escapeHtml(ip)}</div>
                <div style="margin-bottom:8px"><strong>Location</strong>: ${parts.join(' - ') || 'Unknown'}</div>
                ${coords ? `<div style="margin-bottom:8px"><strong>Coordinates</strong>: ${escapeHtml(coords)}</div>` : ''}
                ${isp ? `<div style="margin-bottom:8px"><strong>ISP</strong>: ${isp}</div>` : ''}
                <div style="margin-top:10px"><a target="_blank" rel="noopener" href="${coords ? 'https://www.google.com/maps/search/?api=1&query=' + encodeURIComponent(coords) : '#'}">Open in Google Maps</a></div>
                <pre style="margin-top:12px; padding:8px; background:#f8f8f8; border-radius:6px; overflow:auto; font-size:0.85rem">${escapeHtml(JSON.stringify(d, null, 2))}</pre>
            `;
        }

        function hideCommentMetadata() {
            commentModal.style.display = 'none';
            commentModal.setAttribute('aria-hidden', 'true');
            commentModalBody.innerHTML = '';
        }

        commentModalClose.addEventListener('click', hideCommentMetadata);
        commentModal.addEventListener('click', (e) => {
            if (e.target === commentModal) hideCommentMetadata();
        });
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && commentModal.getAttribute('aria-hidden') === 'false') hideCommentMetadata();
        });

        geoModalClose.addEventListener('click', () => {
            geoModal.style.display = 'none';
            geoModal.setAttribute('aria-hidden', 'true');
            geoModalBody.innerHTML = '';
        });
        geoModal.addEventListener('click', (e) => {
            if (e.target === geoModal) {
                geoModal.style.display = 'none';
                geoModal.setAttribute('aria-hidden', 'true');
                geoModalBody.innerHTML = '';
            }
        });

        function displayComments(comments) {
            commentsContainer.innerHTML = ''; // Clear loading/error messages
            if (comments.length === 0) {
                commentsContainer.innerHTML = '<p>No comments found for this story.</p>';
                return;
            }
            comments.forEach(comment => {
                const commentElement = createCommentElement(comment);
                commentsContainer.appendChild(commentElement);
            });
        }

        function createCommentElement(comment) {
            const commentElement = document.createElement('div');
            commentElement.classList.add('comment');
            if (comment.parentId) {
                commentElement.style.marginLeft = '20px';
            }

            const headerElement = document.createElement('div');
            headerElement.classList.add('comment-header');

            const avatarElement = document.createElement('img');
            avatarElement.classList.add('comment-avatar');
            avatarElement.src = comment.avatar;

            const authorAndLevel = document.createElement('div');

            const authorElement = document.createElement('div');
            authorElement.classList.add('comment-author');
            authorElement.textContent = comment.member || 'Anonymous';

            const levelElement = document.createElement('div');
            levelElement.classList.add('comment-level');
            levelElement.textContent = comment.level || '';

            authorAndLevel.appendChild(authorElement);
            authorAndLevel.appendChild(levelElement);

            headerElement.appendChild(avatarElement);
            headerElement.appendChild(authorAndLevel);

            // details button to open modal with comment metadata
            const detailsBtn = document.createElement('button');
            detailsBtn.textContent = 'Details';
            detailsBtn.title = 'Show comment metadata';
            detailsBtn.style.marginLeft = 'auto';
            detailsBtn.style.background = '#f1f1f1';
            detailsBtn.style.border = '0';
            detailsBtn.style.padding = '6px 8px';
            detailsBtn.style.borderRadius = '6px';
            detailsBtn.style.cursor = 'pointer';
            detailsBtn.addEventListener('click', (ev) => {
                ev.stopPropagation();
                showCommentMetadata(comment);
            });
            headerElement.appendChild(detailsBtn);

            const textElement = document.createElement('div');
            textElement.classList.add('comment-text');
            textElement.innerHTML = comment.body; // Use innerHTML to render HTML tags in comments

            const dateElement = document.createElement('div');
            dateElement.classList.add('comment-date');
            dateElement.textContent = `${comment.since} (${new Date(comment.createdAt).toLocaleString()})`;

            const votesElement = document.createElement('div');
            votesElement.classList.add('comment-votes');
            votesElement.innerHTML = `<strong>${comment.rating}</strong> &mdash; ▲ ${comment.upvotes} ▼ ${comment.downvotes}`;

            commentElement.appendChild(headerElement);
            commentElement.appendChild(textElement);
            commentElement.appendChild(dateElement);
            commentElement.appendChild(votesElement);

            if (comment.answers && comment.answers.length > 0) {
                const answersContainer = document.createElement('div');
                answersContainer.classList.add('answers-container');
                comment.answers.forEach(answer => {
                    const answerElement = createCommentElement(answer);
                    answersContainer.appendChild(answerElement);
                });
                commentElement.appendChild(answersContainer);
            }

            return commentElement;
        }

        fetchStoryData()
            .then(baseUrl => fetchAllComments(baseUrl))
            .catch(error => {
                console.error('Error:', error);
                commentsContainer.innerHTML = `<p>${error.message}</p>`;
            });
    });
    </script>
</body>
</html>